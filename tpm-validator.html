<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPM Timesheet Validation Dashboard</title>
    <link rel="icon" href="favicon.svg" type="image/svg+xml">
    <link rel="stylesheet" href="./style.css">
    <style>
        .validation-dashboard {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .dashboard-header {
            text-align: center;
            margin-bottom: 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
        }
        
        .validation-panels {
            display: grid;
            grid-template-columns: 1fr 2fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .file-management-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .validation-results-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .file-upload-area {
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }
        
        .file-upload-area:hover {
            border-color: #007bff;
        }
        
        .file-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 5px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .file-item:hover {
            background-color: #f8f9fa;
        }
        
        .file-item.selected {
            background-color: #e3f2fd;
            border-color: #2196f3;
        }
        
        .file-status {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
        }
        
        .status-pending { background-color: #ffc107; }
        .status-validating { background-color: #17a2b8; }
        .status-pass { background-color: #28a745; }
        .status-fail { background-color: #dc3545; }
        .status-error { background-color: #6c757d; }
        
        .validation-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid;
        }
        
        .summary-card.total { border-left-color: #6c757d; }
        .summary-card.pass { border-left-color: #28a745; }
        .summary-card.fail { border-left-color: #dc3545; }
        .summary-card.pending { border-left-color: #ffc107; }
        
        .detail-panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .validation-rules-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        
        .validation-rules-table th,
        .validation-rules-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .validation-rules-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }
        
        .rule-status {
            display: flex;
        }
        
        /* Export Check Modal Styles */
        .export-check-modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .export-check-content {
            background-color: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 10px;
            width: 90%;
            max-width: 1000px;
            max-height: 80%;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .export-check-header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #007bff;
        }
        
        .export-check-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }
        
        .export-check-table th,
        .export-check-table td {
            padding: 12px 8px;
            text-align: left;
            border: 1px solid #ddd;
            vertical-align: middle;
        }
        
        .export-check-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .export-check-table tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        .export-check-table tr:hover {
            background-color: #e3f2fd;
        }
        
        .status-icon {
            font-size: 16px;
            margin-right: 5px;
        }
        
        .export-actions {
            text-align: center;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #ddd;
        }
        
        .export-actions button {
            margin: 0 10px;
            padding: 10px 20px;
            font-size: 16px;
        }
        
        .select-all-section {
            margin: 15px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
            align-items: center;
            gap: 8px;
        }
        
        .rule-pass {
            color: #28a745;
            font-weight: 600;
        }
        
        .rule-fail {
            color: #dc3545;
            font-weight: 600;
        }
        
        .error-details {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            padding: 8px;
            margin-top: 5px;
            font-size: 0.9em;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background-color: #007bff;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #0056b3;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-success:hover {
            background-color: #1e7e34;
        }
        
        .btn-danger {
            background-color: #dc3545;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
        }
        
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        
        .btn-warning:hover {
            background-color: #e0a800;
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #545b62;
        }
        
        .hidden {
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #6c757d;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #007bff, #28a745);
            transition: width 0.3s ease;
        }
    </style>
</head>
<body>
    <div class="validation-dashboard">
        <div class="dashboard-header">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                <button onclick="window.location.href='index.html'" style="background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer;">‚Üê ËøîÂõûÈ¶ñÈ†Å</button>
                <h1 style="margin: 0;">üõ°Ô∏è TPM Timesheet Validation Dashboard</h1>
                <div style="width: 80px;"></div> <!-- Spacer for alignment -->
            </div>
            <p>Comprehensive validation tool for timesheet CSV files with business rule compliance checking</p>
        </div>
        
        <div class="validation-panels">
            <!-- File Management Panel -->
            <div class="file-management-panel">
                <h3>üìÅ File Management</h3>
                
                <div class="file-upload-area" id="file-upload-area">
                    <div>
                        <i>üì§</i>
                        <p><strong>Drop CSV files here</strong></p>
                        <p>or click to select multiple files</p>
                        <input type="file" id="csv-file-input" multiple accept=".csv" style="display: none;">
                    </div>
                </div>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="btn-select-files">Select Files</button>
                    <button class="btn btn-success" id="btn-validate-all">Validate All</button>
                    <button class="btn btn-warning" id="btn-export-all-passed" style="display: none;">ÂåØÂá∫ÊâÄÊúâÈÄöÈÅéÊ™îÊ°à</button>
                    <button class="btn btn-danger" id="btn-clear-all">Clear All</button>
                </div>
                
                <!-- Previous export merge section -->
                <div class="merge-previous-section" id="merge-previous-section" style="display: none; margin-top: 20px; padding: 15px; border: 2px dashed #ffc107; border-radius: 10px; background-color: #fff3cd;">
                    <h4 style="margin: 0 0 10px 0; color: #856404;">üì• Âêà‰Ωµ‰πãÂâçÁöÑ TPM ÂåØÂá∫Ê™îÊ°à</h4>
                    <p style="margin: 0 0 10px 0; font-size: 14px; color: #856404;">Â¶ÇÊûúÊÇ®Êúâ‰πãÂâçÂåØÂá∫ÁöÑ TPM Ê™îÊ°àÔºåÂèØ‰ª•ÈÅ∏ÊìáÂêà‰ΩµÂà∞ÈÄôÊ¨°ÁöÑÂåØÂá∫‰∏≠</p>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <input type="file" id="previous-export-file" accept=".csv" style="display: none;">
                        <button class="btn btn-secondary" id="btn-select-previous">ÈÅ∏Êìá‰πãÂâçÁöÑÂåØÂá∫Ê™îÊ°à</button>
                        <span id="previous-file-name" style="color: #28a745; font-weight: bold;"></span>
                        <button class="btn btn-sm btn-danger" id="btn-clear-previous" style="display: none; padding: 5px 10px; font-size: 12px;">ÁßªÈô§</button>
                    </div>
                </div>
                
                <div class="file-list" id="file-list">
                    <!-- Files will be dynamically added here -->
                </div>
            </div>
            
            <!-- Validation Results Panel -->
            <div class="validation-results-panel">
                <h3>üìä Validation Summary</h3>
                
                <div class="validation-summary">
                    <div class="summary-card total">
                        <h4 id="total-files">0</h4>
                        <p>Total Files</p>
                    </div>
                    <div class="summary-card pass">
                        <h4 id="pass-files">0</h4>
                        <p>Passed</p>
                    </div>
                    <div class="summary-card fail">
                        <h4 id="fail-files">0</h4>
                        <p>Failed</p>
                    </div>
                    <div class="summary-card pending">
                        <h4 id="pending-files">0</h4>
                        <p>Pending</p>
                    </div>
                </div>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="validation-progress" style="width: 0%"></div>
                </div>
                
                <div id="overall-status" class="loading hidden">
                    Ready to validate files...
                </div>
                
                <div id="validation-status" style="text-align: center; padding: 10px; color: #6c757d; font-style: italic;">
                    Ê∫ñÂÇôÈ©óË≠âÊ™îÊ°à...
                </div>
            </div>
        </div>
        
        <!-- Detailed Validation Results Panel -->
        <div class="detail-panel" id="detail-panel">
            <h3 id="detail-panel-title">üîç Select a file to view detailed validation results</h3>
            
            <div id="detail-content" class="hidden">
                <div class="file-info">
                    <h4 id="selected-file-name">File Name</h4>
                    <p id="selected-file-info">File information will appear here</p>
                </div>
                
                <table class="validation-rules-table">
                    <thead>
                        <tr>
                            <th>Validation Rule</th>
                            <th>Status</th>
                            <th>Issues Found</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="validation-results-tbody">
                        <!-- Validation results will be dynamically populated here -->
                    </tbody>
                </table>
                
                <div class="action-buttons">
                    <button class="btn btn-primary" id="btn-revalidate-file">Re-validate File</button>
                    <button class="btn btn-success" id="btn-export-corrected" style="display: none;">ÂåØÂá∫Ê†ºÂºè‰øÆÊ≠£Áâà</button>
                    <button class="btn btn-danger" id="btn-remove-file">Remove File</button>
                </div>
            </div>
        </div>
    </div>

    <script src="./app-bundled.js"></script>
    <script>
        // ==================== TPM VALIDATION DASHBOARD ====================
        console.log('üõ°Ô∏è TPM Validation Dashboard loaded');
        
        // Global state management
        let validationFiles = new Map(); // filename -> {file, status, results}
        let referenceData = {
            projects: [],
            products: [],
            activities: []
        };
        
        // Load reference data on page load
        async function loadReferenceData() {
            try {
                console.log('Loading reference data...');
                
                // Load project codes
                const projectResponse = await fetch('projectcode.csv');
                const projectText = await projectResponse.text();
                referenceData.projects = parseCSVContent(projectText);
                
                // Load product codes  
                const productResponse = await fetch('productcode.csv');
                const productText = await productResponse.text();
                referenceData.products = parseCSVContent(productText);
                
                // Load activity types
                const activityResponse = await fetch('activityType.csv');
                const activityText = await activityResponse.text();
                referenceData.activities = parseCSVContent(activityText);
                
                console.log('Reference data loaded:', {
                    projects: referenceData.projects.length,
                    products: referenceData.products.length,
                    activities: referenceData.activities.length
                });
                
                return true;
            } catch (error) {
                console.error('Error loading reference data:', error);
                alert('ÁÑ°Ê≥ïËºâÂÖ•ÂèÉËÄÉË≥áÊñôÊ™îÊ°àÔºåË´ãÁ¢∫Ë™ç CSV Ê™îÊ°àÂ≠òÂú®');
                return false;
            }
        }
        
        // CSV parsing function (reuse from app-bundled.js logic)
        function parseCSVContent(text) {
            const cleanText = text.replace(/^\uFEFF/, '');
            const lines = cleanText.trim().split(/\r?\n/);
            if (lines.length < 2) return [];
            
            const headers = parseCSVLine(lines[0]);
            
            return lines.slice(1).map(line => {
                if (!line.trim()) return null;
                const fields = parseCSVLine(line);
                const obj = {};
                headers.forEach((h, i) => {
                    obj[h] = fields[i] || '';
                });
                
                // Normalize date formats after parsing
                if (obj.Date) {
                    obj.Date = normalizeDateFormat(obj.Date);
                }
                if (obj['Start Date']) {
                    obj['Start Date'] = normalizeDateFormat(obj['Start Date']);
                }
                if (obj['End Date']) {
                    obj['End Date'] = normalizeDateFormat(obj['End Date']);
                }
                
                return obj;
            }).filter(obj => obj !== null);
        }
        
        // CSV line parsing function (from app-bundled.js)
        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            let i = 0;
            
            while (i < line.length) {
                const char = line[i];
                
                if (char === '"') {
                    if (inQuotes && line[i + 1] === '"') {
                        current += '"';
                        i += 2;
                    } else {
                        inQuotes = !inQuotes;
                        i++;
                    }
                } else if (char === ',' && !inQuotes) {
                    result.push(current.trim());
                    current = '';
                    i++;
                } else {
                    current += char;
                    i++;
                }
            }
            result.push(current.trim());
            return result;
        }
        
        // ==================== VALIDATION RULES ====================
        
        // 1. Required fields validation
        function validateRequiredFields(entry, lineNumber) {
            const requiredFields = ['Task', 'Activity Type', 'Zone', 'Project', 'Product Module', 'Regular Hours', 'Date'];
            const errors = [];
            
            requiredFields.forEach(field => {
                if (!entry[field] || String(entry[field]).trim() === '') {
                    errors.push(`Á¨¨ ${lineNumber} Ë°åÔºöÁº∫Â∞ëÂøÖÂ°´Ê¨Ñ‰Ωç "${field}"`);
                }
            });
            
            return {
                ruleName: 'ÂøÖÂ°´Ê¨Ñ‰ΩçÊ™¢Êü•',
                passed: errors.length === 0,
                errors: errors,
                description: 'Ê™¢Êü•ÊâÄÊúâÂøÖÂ°´Ê¨Ñ‰ΩçÊòØÂê¶ÊúâÂÄº'
            };
        }
        
        // Helper function to normalize date format to YYYY/MM/DD
        function normalizeDateFormat(dateStr) {
            if (!dateStr) return dateStr;
            
            // If already in YYYY/MM/DD format with zero padding, return as is
            if (/^\d{4}\/\d{2}\/\d{2}$/.test(dateStr)) {
                return dateStr;
            }
            
            // Convert YYYY-MM-DD to YYYY/MM/DD
            if (dateStr.includes('-')) {
                const parts = dateStr.split('-');
                if (parts.length === 3) {
                    const year = parts[0];
                    const month = parts[1].padStart(2, '0');
                    const day = parts[2].padStart(2, '0');
                    return `${year}/${month}/${day}`;
                }
            }
            
            // Convert YYYY/M/D to YYYY/MM/DD (add zero padding)
            if (dateStr.includes('/')) {
                const parts = dateStr.split('/');
                if (parts.length === 3) {
                    const year = parts[0];
                    const month = parts[1].padStart(2, '0');
                    const day = parts[2].padStart(2, '0');
                    return `${year}/${month}/${day}`;
                }
            }
            
            return dateStr;
        }

        // 2. Date format validation (only accepts YYYY/MM/DD format)
        function validateDateFormat(entry, lineNumber) {
            const errors = [];
            const requiredDatePattern = /^\d{4}\/\d{2}\/\d{2}$/; // Strict YYYY/MM/DD with zero padding
            
            // Check main date field
            if (entry.Date && !requiredDatePattern.test(entry.Date)) {
                errors.push(`Á¨¨ ${lineNumber} Ë°åÔºöÊó•ÊúüÊ†ºÂºèÈåØË™§ "${entry.Date}"ÔºåÊáâÁÇ∫ YYYY/MM/DD Ê†ºÂºèÔºàÈúÄÈõ∂Â°´ÂÖÖÔºåÂ¶ÇÔºö2025/06/09Ôºâ`);
            }
            
            // Check start date if exists
            if (entry['Start Date'] && !requiredDatePattern.test(entry['Start Date'])) {
                errors.push(`Á¨¨ ${lineNumber} Ë°åÔºöÈñãÂßãÊó•ÊúüÊ†ºÂºèÈåØË™§ "${entry['Start Date']}"ÔºåÊáâÁÇ∫ YYYY/MM/DD Ê†ºÂºèÔºàÈúÄÈõ∂Â°´ÂÖÖÔºåÂ¶ÇÔºö2025/06/09Ôºâ`);
            }
            
            // Check end date if exists
            if (entry['End Date'] && !requiredDatePattern.test(entry['End Date'])) {
                errors.push(`Á¨¨ ${lineNumber} Ë°åÔºöÁµêÊùüÊó•ÊúüÊ†ºÂºèÈåØË™§ "${entry['End Date']}"ÔºåÊáâÁÇ∫ YYYY/MM/DD Ê†ºÂºèÔºàÈúÄÈõ∂Â°´ÂÖÖÔºåÂ¶ÇÔºö2025/06/09Ôºâ`);
            }
            
            return {
                ruleName: 'Êó•ÊúüÊ†ºÂºèÊ™¢Êü•',
                passed: errors.length === 0,
                errors: errors,
                description: 'Ê™¢Êü•Êó•ÊúüÊòØÂê¶Á¨¶Âêà YYYY/MM/DD Ê†ºÂºèÔºàÈúÄÈõ∂Â°´ÂÖÖÔºâ'
            };
        }
        
        // 3. Regular hours limitation (max 8 hours)
        function validateRegularHours(entry, lineNumber) {
            const errors = [];
            const regularHours = parseFloat(entry['Regular Hours']) || 0;
            
            if (regularHours > 8) {
                errors.push(`Á¨¨ ${lineNumber} Ë°åÔºöÊ≠£Â∏∏Â∑•ÊôÇ ${regularHours} Â∞èÊôÇË∂ÖÈÅé 8 Â∞èÊôÇÈôêÂà∂`);
            }
            
            if (regularHours < 0) {
                errors.push(`Á¨¨ ${lineNumber} Ë°åÔºöÊ≠£Â∏∏Â∑•ÊôÇ‰∏çËÉΩÁÇ∫Ë≤†Êï∏ ${regularHours}`);
            }
            
            return {
                ruleName: 'Ê≠£Â∏∏Â∑•ÊôÇÈôêÂà∂Ê™¢Êü•',
                passed: errors.length === 0,
                errors: errors,
                description: 'Ê™¢Êü•Ê≠£Â∏∏Â∑•ÊôÇÊòØÂê¶Ë∂ÖÈÅé 8 Â∞èÊôÇÈôêÂà∂'
            };
        }
        
        // 4. Zone/Project relationship validation
        function validateZoneProjectRelationship(entry, lineNumber) {
            const errors = [];
            const zone = entry.Zone;
            const project = entry.Project;
            
            if (zone && project) {
                const validProject = referenceData.projects.find(p => 
                    p.Zone === zone && p.Project === project
                );
                
                if (!validProject) {
                    errors.push(`Á¨¨ ${lineNumber} Ë°åÔºöZone "${zone}" Ëàá Project "${project}" ÁöÑÁµÑÂêà‰∏çÂ≠òÂú®ÊñºÂèÉËÄÉË≥áÊñô‰∏≠`);
                }
            }
            
            return {
                ruleName: 'Zone/Project Èóú‰øÇÊ™¢Êü•',
                passed: errors.length === 0,
                errors: errors,
                description: 'Ê™¢Êü• Zone Âíå Project ÁöÑÁµÑÂêàÊòØÂê¶Â≠òÂú®Êñº projectcode.csv ‰∏≠'
            };
        }
        
        // 5. Zone/Product relationship validation
        function validateZoneProductRelationship(entry, lineNumber) {
            const errors = [];
            const zone = entry.Zone;
            const productModule = entry['Product Module'];
            
            if (zone && productModule) {
                const validProduct = referenceData.products.find(p => 
                    p.Zone === zone && p['Product Module'] === productModule
                );
                
                if (!validProduct) {
                    errors.push(`Á¨¨ ${lineNumber} Ë°åÔºöZone "${zone}" Ëàá Product Module "${productModule}" ÁöÑÁµÑÂêà‰∏çÂ≠òÂú®ÊñºÂèÉËÄÉË≥áÊñô‰∏≠`);
                }
            }
            
            return {
                ruleName: 'Zone/Product Èóú‰øÇÊ™¢Êü•',
                passed: errors.length === 0,
                errors: errors,
                description: 'Ê™¢Êü• Zone Âíå Product Module ÁöÑÁµÑÂêàÊòØÂê¶Â≠òÂú®Êñº productcode.csv ‰∏≠'
            };
        }
        
        // 6. Project/PM mapping validation
        function validateProjectPMMapping(entry, lineNumber) {
            const errors = [];
            const project = entry.Project;
            const zone = entry.Zone;
            const pmField = entry.PM;
            
            if (project && zone) {
                const projectData = referenceData.projects.find(p => 
                    p.Zone === zone && p.Project === project
                );
                
                if (projectData && projectData.PM && pmField) {
                    if (projectData.PM !== pmField) {
                        errors.push(`Á¨¨ ${lineNumber} Ë°åÔºöProject "${project}" ÁöÑ PM ÊáâÁÇ∫ "${projectData.PM}"Ôºå‰ΩÜÂ°´ÂÖ• "${pmField}"`);
                    }
                }
            }
            
            return {
                ruleName: 'Project/PM Â∞çÊáâÊ™¢Êü•',
                passed: errors.length === 0,
                errors: errors,
                description: 'Ê™¢Êü• Project Âíå PM ÁöÑÂ∞çÊáâÈóú‰øÇÊòØÂê¶Ê≠£Á¢∫'
            };
        }
        
        // 7. Admin/Training activity validation
        function validateAdminTrainingActivity(entry, lineNumber) {
            const errors = [];
            const activityType = entry['Activity Type'];
            const zone = entry.Zone;
            const project = entry.Project;
            const productModule = entry['Product Module'];
            
            if (activityType === 'Admin / Training') {
                if (zone !== 'Admin') {
                    errors.push(`Á¨¨ ${lineNumber} Ë°åÔºöÊ¥ªÂãïÈ°ûÂûãÁÇ∫ "Admin / Training" ÊôÇÔºåZone ÂøÖÈ†àÁÇ∫ "Admin"Ôºå‰ΩÜÂ°´ÂÖ• "${zone}"`);
                }
                
                if (project !== 'Admin') {
                    errors.push(`Á¨¨ ${lineNumber} Ë°åÔºöÊ¥ªÂãïÈ°ûÂûãÁÇ∫ "Admin / Training" ÊôÇÔºåProject ÂøÖÈ†àÁÇ∫ "Admin"Ôºå‰ΩÜÂ°´ÂÖ• "${project}"`);
                }
                
                if (productModule !== 'Non Product Non Product') {
                    errors.push(`Á¨¨ ${lineNumber} Ë°åÔºöÊ¥ªÂãïÈ°ûÂûãÁÇ∫ "Admin / Training" ÊôÇÔºåProduct Module ÂøÖÈ†àÁÇ∫ "Non Product Non Product"Ôºå‰ΩÜÂ°´ÂÖ• "${productModule}"`);
                }
            }
            
            return {
                ruleName: 'Admin/Training Ê¥ªÂãïÈ°ûÂûãÊ™¢Êü•',
                passed: errors.length === 0,
                errors: errors,
                description: 'Ê™¢Êü• Admin/Training Ê¥ªÂãïÈ°ûÂûãÁöÑ Zone/Project/Product Ë®≠ÂÆöÊòØÂê¶Ê≠£Á¢∫'
            };
        }
        
        // 8. Activity type validation
        function validateActivityType(entry, lineNumber) {
            const errors = [];
            const activityType = entry['Activity Type'];
            
            if (activityType) {
                const validActivity = referenceData.activities.find(a => 
                    a['Activity Type'] === activityType
                );
                
                if (!validActivity) {
                    errors.push(`Á¨¨ ${lineNumber} Ë°åÔºöÊ¥ªÂãïÈ°ûÂûã "${activityType}" ‰∏çÂ≠òÂú®ÊñºÂèÉËÄÉË≥áÊñô‰∏≠`);
                }
            }
            
            return {
                ruleName: 'Ê¥ªÂãïÈ°ûÂûãÊ™¢Êü•',
                passed: errors.length === 0,
                errors: errors,
                description: 'Ê™¢Êü•Ê¥ªÂãïÈ°ûÂûãÊòØÂê¶Â≠òÂú®Êñº activityType.csv ‰∏≠'
            };
        }
        
        // 9. Numeric validation for hours
        function validateNumericFields(entry, lineNumber) {
            const errors = [];
            
            // Regular Hours validation
            const regularHours = entry['Regular Hours'];
            if (regularHours && isNaN(parseFloat(regularHours))) {
                errors.push(`Á¨¨ ${lineNumber} Ë°åÔºöÊ≠£Â∏∏Â∑•ÊôÇ "${regularHours}" ‰∏çÊòØÊúâÊïàÊï∏Â≠ó`);
            }
            
            // OT Hours validation
            const otHours = entry['OT Hours'];
            if (otHours && isNaN(parseFloat(otHours))) {
                errors.push(`Á¨¨ ${lineNumber} Ë°åÔºöÂä†Áè≠Â∑•ÊôÇ "${otHours}" ‰∏çÊòØÊúâÊïàÊï∏Â≠ó`);
            }
            
            // TTL Hours validation
            const ttlHours = entry['TTL_Hours'];
            if (ttlHours && isNaN(parseFloat(ttlHours))) {
                errors.push(`Á¨¨ ${lineNumber} Ë°åÔºöÁ∏ΩÂ∑•ÊôÇ "${ttlHours}" ‰∏çÊòØÊúâÊïàÊï∏Â≠ó`);
            }
            
            return {
                ruleName: 'Êï∏Â≠óÊ¨Ñ‰ΩçÊ†ºÂºèÊ™¢Êü•',
                passed: errors.length === 0,
                errors: errors,
                description: 'Ê™¢Êü•Â∑•ÊôÇÊ¨Ñ‰ΩçÊòØÂê¶ÁÇ∫ÊúâÊïàÊï∏Â≠ó'
            };
        }
        
        // 10. Weekly total regular hours validation (must be 40 hours)
        function validateWeeklyTotalHours(entries) {
            const errors = [];
            
            // Calculate total regular hours for the week
            let totalRegularHours = 0;
            entries.forEach((entry, index) => {
                const regularHours = parseFloat(entry['Regular Hours']) || 0;
                totalRegularHours += regularHours;
            });
            
            // Check if total is exactly 40 hours
            if (totalRegularHours !== 40) {
                errors.push(`ÂÖ®ÈÄ±Ê≠£Â∏∏Â∑•ÊôÇÂä†Á∏Ω ${totalRegularHours} Â∞èÊôÇÔºå‰∏çÁ≠âÊñºË¶ÅÊ±ÇÁöÑ 40 Â∞èÊôÇ`);
            }
            
            return {
                ruleName: 'ÈÄ±Á∏ΩÂ∑•ÊôÇÊ™¢Êü•',
                passed: errors.length === 0,
                errors: errors,
                description: 'Ê™¢Êü•ÂÖ®ÈÄ±Ê≠£Â∏∏Â∑•ÊôÇÂä†Á∏ΩÊòØÂê¶ÁÇ∫ 40 Â∞èÊôÇ'
            };
        }
        
        // Master validation function
        async function validateCSVFile(file) {
            try {
                console.log(`üîç ÈñãÂßãÈ©óË≠âÊ™îÊ°à: ${file.name}`);
                
                const text = await file.text();
                const entries = parseCSVContent(text);
                
                if (entries.length === 0) {
                    return {
                        fileName: file.name,
                        status: 'error',
                        totalEntries: 0,
                        passedRules: 0,
                        failedRules: 0,
                        overallResult: 'FAIL',
                        validationResults: [],
                        data: [], // Add empty data array for consistency
                        summary: 'Ê™îÊ°àÁÇ∫Á©∫ÊàñÊ†ºÂºèÈåØË™§'
                    };
                }
                
                console.log(`üìä Ëß£Êûê‰∫Ü ${entries.length} Á≠ÜË®òÈåÑ`);
                
                const validationResults = [];
                let totalPassed = 0;
                let totalFailed = 0;
                
                // Run all validation rules for all entries
                entries.forEach((entry, index) => {
                    const lineNumber = index + 2; // +2 because of header row and 0-based index
                    
                    const rules = [
                        validateRequiredFields(entry, lineNumber),
                        validateDateFormat(entry, lineNumber),
                        validateRegularHours(entry, lineNumber),
                        validateZoneProjectRelationship(entry, lineNumber),
                        validateZoneProductRelationship(entry, lineNumber),
                        validateProjectPMMapping(entry, lineNumber),
                        validateAdminTrainingActivity(entry, lineNumber),
                        validateActivityType(entry, lineNumber),
                        validateNumericFields(entry, lineNumber)
                    ];
                    
                    rules.forEach(rule => {
                        if (rule.passed) {
                            totalPassed++;
                        } else {
                            totalFailed++;
                        }
                        
                        const existingRule = validationResults.find(r => r.ruleName === rule.ruleName);
                        if (existingRule) {
                            existingRule.errors.push(...rule.errors);
                            existingRule.passed = existingRule.passed && rule.passed;
                        } else {
                            validationResults.push({
                                ruleName: rule.ruleName,
                                description: rule.description,
                                passed: rule.passed,
                                errors: [...rule.errors]
                            });
                        }
                    });
                });
                
                // Add weekly total hours validation
                const weeklyTotalRule = validateWeeklyTotalHours(entries);
                if (weeklyTotalRule.passed) {
                    totalPassed++;
                } else {
                    totalFailed++;
                }
                
                const existingWeeklyRule = validationResults.find(r => r.ruleName === weeklyTotalRule.ruleName);
                if (existingWeeklyRule) {
                    existingWeeklyRule.errors.push(...weeklyTotalRule.errors);
                    existingWeeklyRule.passed = existingWeeklyRule.passed && weeklyTotalRule.passed;
                } else {
                    validationResults.push({
                        ruleName: weeklyTotalRule.ruleName,
                        description: weeklyTotalRule.description,
                        passed: weeklyTotalRule.passed,
                        errors: [...weeklyTotalRule.errors]
                    });
                }
                
                const overallResult = totalFailed === 0 ? 'PASS' : 'FAIL';
                
                console.log(`‚úÖ È©óË≠âÂÆåÊàê: ${file.name} - ${overallResult}`);
                
                return {
                    fileName: file.name,
                    status: 'completed',
                    totalEntries: entries.length,
                    passedRules: totalPassed,
                    failedRules: totalFailed,
                    overallResult: overallResult,
                    validationResults: validationResults,
                    data: entries, // Include the parsed data
                    summary: `ÂÖ± ${entries.length} Á≠ÜË®òÈåÑÔºå${totalFailed} ÂÄãÈ©óË≠âÈåØË™§`
                };
                
            } catch (error) {
                console.error(`‚ùå È©óË≠âÊ™îÊ°à ${file.name} ÊôÇÁôºÁîüÈåØË™§:`, error);
                return {
                    fileName: file.name,
                    status: 'error',
                    totalEntries: 0,
                    passedRules: 0,
                    failedRules: 0,
                    overallResult: 'ERROR',
                    validationResults: [],
                    data: [], // Empty data array for error case
                    summary: `È©óË≠âÊôÇÁôºÁîüÈåØË™§: ${error.message}`
                };
            }
        }
        
        // ==================== UI MANAGEMENT ====================
        
        function updateSummaryCards() {
            const totalFiles = validationFiles.size;
            const passFiles = Array.from(validationFiles.values()).filter(f => f.status === 'completed' && f.results?.overallResult === 'PASS').length;
            const failFiles = Array.from(validationFiles.values()).filter(f => f.status === 'completed' && f.results?.overallResult === 'FAIL').length;
            const pendingFiles = Array.from(validationFiles.values()).filter(f => f.status === 'pending').length;
            
            document.getElementById('total-files').textContent = totalFiles;
            document.getElementById('pass-files').textContent = passFiles;
            document.getElementById('fail-files').textContent = failFiles;
            document.getElementById('pending-files').textContent = pendingFiles;
            
            // Show/hide export all passed files button and merge section based on whether there are passed files
            const exportAllButton = document.getElementById('btn-export-all-passed');
            const mergePreviousSection = document.getElementById('merge-previous-section');
            if (passFiles > 0) {
                exportAllButton.style.display = 'inline-block';
                mergePreviousSection.style.display = 'block';
            } else {
                exportAllButton.style.display = 'none';
                mergePreviousSection.style.display = 'none';
            }
        }
        
        function updateFileList() {
            const fileList = document.getElementById('file-list');
            fileList.innerHTML = '';
            
            if (validationFiles.size === 0) {
                fileList.innerHTML = '<p style="text-align: center; color: #6c757d;">Â∞öÊú™ÈÅ∏ÊìáÊ™îÊ°à</p>';
                return;
            }
            
            validationFiles.forEach((fileData, fileName) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'file-item';
                fileItem.onclick = () => selectFile(fileName);
                
                let statusClass = 'status-pending';
                let statusText = 'ÂæÖÈ©óË≠â';
                
                if (fileData.status === 'validating') {
                    statusClass = 'status-validating';
                    statusText = 'È©óË≠â‰∏≠...';
                } else if (fileData.status === 'completed') {
                    if (fileData.results?.overallResult === 'PASS') {
                        statusClass = 'status-pass';
                        statusText = 'ÈÄöÈÅé';
                    } else {
                        statusClass = 'status-fail';
                        statusText = 'Â§±Êïó';
                    }
                } else if (fileData.status === 'error') {
                    statusClass = 'status-error';
                    statusText = 'ÈåØË™§';
                }
                
                fileItem.innerHTML = `
                    <div>
                        <strong>${fileName}</strong>
                        <br>
                        <small>${fileData.results?.summary || 'Â∞öÊú™È©óË≠â'}</small>
                    </div>
                    <div class="file-status">
                        <span class="status-indicator ${statusClass}"></span>
                        <span>${statusText}</span>
                    </div>
                `;
                
                fileList.appendChild(fileItem);
            });
        }
        
        function selectFile(fileName) {
            // Remove previous selection
            document.querySelectorAll('.file-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            // Add selection to clicked item
            event.currentTarget.classList.add('selected');
            
            const fileData = validationFiles.get(fileName);
            showFileDetails(fileData);
        }
        
        function showFileDetails(fileData) {
            const detailPanel = document.getElementById('detail-panel');
            const detailContent = document.getElementById('detail-content');
            const title = document.getElementById('detail-panel-title');
            
            title.textContent = `üîç ${fileData.fileName} Ë©≥Á¥∞È©óË≠âÁµêÊûú`;
            
            if (!fileData.results) {
                detailContent.innerHTML = '<p>Ë©≤Ê™îÊ°àÂ∞öÊú™ÂÆåÊàêÈ©óË≠â</p>';
                detailContent.classList.remove('hidden');
                return;
            }
            
            document.getElementById('selected-file-name').textContent = fileData.fileName;
            document.getElementById('selected-file-info').textContent = 
                `Á∏ΩË®òÈåÑÊï∏: ${fileData.results.totalEntries} | È©óË≠âÁµêÊûú: ${fileData.results.overallResult} | ${fileData.results.summary}`;
            
            const tbody = document.getElementById('validation-results-tbody');
            tbody.innerHTML = '';
            
            fileData.results.validationResults.forEach(rule => {
                const row = document.createElement('tr');
                
                const statusHtml = rule.passed 
                    ? '<span class="rule-pass">‚úÖ PASS</span>'
                    : '<span class="rule-fail">‚ùå FAIL</span>';
                
                const issuesCount = rule.errors.length;
                const issuesHtml = issuesCount > 0 
                    ? `<span style="color: #dc3545; font-weight: bold;">${issuesCount} ÂÄãÂïèÈ°å</span>`
                    : '<span style="color: #28a745;">ÁÑ°ÂïèÈ°å</span>';
                
                const detailsHtml = rule.errors.length > 0 
                    ? `<div class="error-details">${rule.errors.join('<br>')}</div>`
                    : '';
                
                row.innerHTML = `
                    <td>${rule.ruleName}</td>
                    <td class="rule-status">${statusHtml}</td>
                    <td>${issuesHtml}</td>
                    <td>
                        <small>${rule.description}</small>
                        ${detailsHtml}
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // Check if we should show the export button (only date format errors)
            const exportButton = document.getElementById('btn-export-corrected');
            if (fileData.results && !fileData.results.overallResult) {
                // Check if only date format errors exist
                const onlyDateFormatErrors = fileData.results.validationResults.every(rule => {
                    if (rule.passed) return true; // Passed rules are ok
                    return rule.ruleName === 'Êó•ÊúüÊ†ºÂºèÊ™¢Êü•'; // Only date format check failures are acceptable
                });
                
                const hasDateFormatErrors = fileData.results.validationResults.some(rule => 
                    rule.ruleName === 'Êó•ÊúüÊ†ºÂºèÊ™¢Êü•' && !rule.passed
                );
                
                if (onlyDateFormatErrors && hasDateFormatErrors) {
                    exportButton.style.display = 'inline-block';
                } else {
                    exportButton.style.display = 'none';
                }
            } else {
                exportButton.style.display = 'none';
            }
            
            detailContent.classList.remove('hidden');
        }
        
        // ==================== EVENT HANDLERS ====================
        
        async function handleFileSelection(files) {
            console.log(`üìÅ ÈÅ∏Êìá‰∫Ü ${files.length} ÂÄãÊ™îÊ°à`);
            
            for (const file of files) {
                if (!file.name.toLowerCase().endsWith('.csv')) {
                    alert(`Ê™îÊ°à "${file.name}" ‰∏çÊòØ CSV Ê†ºÂºèÔºåÂ∑≤Ë∑≥ÈÅé`);
                    continue;
                }
                
                validationFiles.set(file.name, {
                    file: file,
                    fileName: file.name,
                    status: 'pending',
                    results: null
                });
            }
            
            updateFileList();
            updateSummaryCards();
        }
        
        async function validateAllFiles() {
            const pendingFiles = Array.from(validationFiles.values()).filter(f => f.status === 'pending');
            
            if (pendingFiles.length === 0) {
                alert('Ê≤íÊúâÂæÖÈ©óË≠âÁöÑÊ™îÊ°à');
                return;
            }
            
            console.log(`üöÄ ÈñãÂßãÊâπÊ¨°È©óË≠â ${pendingFiles.length} ÂÄãÊ™îÊ°à`);
            
            const totalFiles = pendingFiles.length;
            let completedFiles = 0;
            
            for (const fileData of pendingFiles) {
                // Update status to validating
                fileData.status = 'validating';
                updateFileList();
                
                // Perform validation
                const results = await validateCSVFile(fileData.file);
                
                // Update results
                fileData.status = results.status;
                fileData.results = results;
                fileData.data = results.data; // Store the parsed data
                
                completedFiles++;
                
                // Update progress
                const progress = (completedFiles / totalFiles) * 100;
                document.getElementById('validation-progress').style.width = `${progress}%`;
                
                updateFileList();
                updateSummaryCards();
                
                // Small delay to show progress
                await new Promise(resolve => setTimeout(resolve, 100));
            }
            
            console.log('‚úÖ ÊâπÊ¨°È©óË≠âÂÆåÊàê');
            alert('ÊâÄÊúâÊ™îÊ°àÈ©óË≠âÂÆåÊàêÔºÅ');
        }
        
        function clearAllFiles() {
            if (validationFiles.size === 0) return;
            
            if (confirm(`Á¢∫ÂÆöË¶ÅÊ∏ÖÈô§ÊâÄÊúâ ${validationFiles.size} ÂÄãÊ™îÊ°àÂóéÔºü`)) {
                validationFiles.clear();
                updateFileList();
                updateSummaryCards();
                
                // Hide detail panel
                document.getElementById('detail-content').classList.add('hidden');
                document.getElementById('detail-panel-title').textContent = 'üîç Select a file to view detailed validation results';
                
                // Reset progress
                document.getElementById('validation-progress').style.width = '0%';
            }
        }
        
        function revalidateCurrentFile() {
            if (!currentSelectedFile) {
                alert('Ë´ãÂÖàÈÅ∏ÊìáË¶ÅÈáçÊñ∞È©óË≠âÁöÑÊ™îÊ°à');
                return;
            }
            
            const fileInfo = validationFiles.get(currentSelectedFile);
            if (fileInfo) {
                validateSingleFile(fileInfo.file);
            }
        }
        
        function removeCurrentFile() {
            if (!currentSelectedFile) {
                alert('Ë´ãÂÖàÈÅ∏ÊìáË¶ÅÁßªÈô§ÁöÑÊ™îÊ°à');
                return;
            }
            
            if (confirm(`Á¢∫ÂÆöË¶ÅÁßªÈô§Ê™îÊ°à "${currentSelectedFile}" ÂóéÔºü`)) {
                validationFiles.delete(currentSelectedFile);
                updateFileList();
                updateSummaryCards();
                
                // Hide detail panel
                document.getElementById('detail-content').classList.add('hidden');
                document.getElementById('detail-panel-title').textContent = 'üîç Select a file to view detailed validation results';
                currentSelectedFile = null;
            }
        }
        
        function exportCorrectedFile() {
            if (!currentSelectedFile) {
                alert('Ë´ãÂÖàÈÅ∏ÊìáË¶ÅÂåØÂá∫ÁöÑÊ™îÊ°à');
                return;
            }
            
            const fileInfo = validationFiles.get(currentSelectedFile);
            if (!fileInfo || !fileInfo.data) {
                alert('ÁÑ°Ê≥ïÂèñÂæóÊ™îÊ°àË≥áÊñô');
                return;
            }
            
            try {
                // Create corrected CSV content with proper date format
                const correctedData = fileInfo.data.map(entry => {
                    const correctedEntry = { ...entry };
                    
                    // Apply date format normalization to YYYY/MM/DD
                    if (correctedEntry.Date) {
                        correctedEntry.Date = normalizeDateFormat(correctedEntry.Date);
                    }
                    if (correctedEntry['Start Date']) {
                        correctedEntry['Start Date'] = normalizeDateFormat(correctedEntry['Start Date']);
                    }
                    if (correctedEntry['End Date']) {
                        correctedEntry['End Date'] = normalizeDateFormat(correctedEntry['End Date']);
                    }
                    
                    return correctedEntry;
                });
                
                // Generate CSV headers
                const headers = [
                    'Name', 'Zone', 'Project', 'Product Module', 'Activity Type', 'Task',
                    'Regular Hours', 'OT Hours', 'TTL_Hours', 'Date', 'Start Date', 'End Date',
                    'Comments', 'PM', 'InternalOrOutsource'
                ];
                
                // Generate CSV rows
                const csvRows = [headers];
                correctedData.forEach(entry => {
                    csvRows.push([
                        entry.Name || '',
                        entry.Zone || '',
                        entry.Project || '',
                        entry['Product Module'] || '',
                        entry['Activity Type'] || '',
                        entry.Task || '',
                        entry['Regular Hours'] || '',
                        entry['OT Hours'] || '',
                        entry.TTL_Hours || '',
                        entry.Date || '',
                        entry['Start Date'] || '',
                        entry['End Date'] || '',
                        entry.Comments || '',
                        entry.PM || '',
                        entry.InternalOrOutsource || ''
                    ]);
                });
                
                // Generate CSV content with proper escaping
                const csvContent = csvRows.map(row =>
                    row.map(field => {
                        const fieldStr = String(field);
                        if (fieldStr.includes(',') || fieldStr.includes('\n') || fieldStr.includes('"')) {
                            return '"' + fieldStr.replace(/"/g, '""') + '"';
                        }
                        return fieldStr;
                    }).join(',')
                ).join('\n');
                
                // Create download
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `${currentSelectedFile.replace('.csv', '')}_corrected.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert(`Â∑≤ÂåØÂá∫Ê†ºÂºè‰øÆÊ≠£ÁâàÔºö${currentSelectedFile.replace('.csv', '')}_corrected.csv`);
                
            } catch (error) {
                console.error('ÂåØÂá∫Â§±Êïó:', error);
                alert('ÂåØÂá∫Â§±ÊïóÔºåË´ãÊ™¢Êü•ÊéßÂà∂Âè∞ÈåØË™§Ë®äÊÅØ');
            }
        }
        
        function exportAllPassedFiles() {
            // Get all files and categorize them
            const passedFiles = [];
            const failedFiles = [];
            
            validationFiles.forEach((fileInfo, fileName) => {
                if (fileInfo.results) {
                    if (fileInfo.results.overallResult === 'PASS') {
                        passedFiles.push({
                            fileName: fileName,
                            data: fileInfo.data
                        });
                    } else if (fileInfo.results.overallResult === 'FAIL') {
                        failedFiles.push(fileName);
                    }
                }
            });
            
            if (passedFiles.length === 0) {
                alert('Ê≤íÊúâÈÄöÈÅéÈ©óË≠âÁöÑÊ™îÊ°àÂèØ‰ª•ÂåØÂá∫');
                return;
            }
            
            // Show export check modal instead of simple confirmation
            showExportCheckModal(passedFiles, failedFiles);
        }
        
        // ==================== EXPORT CHECK MODAL FUNCTIONS ====================
        
        function showExportCheckModal(passedFiles, failedFiles) {
            const modal = document.getElementById('export-check-modal');
            const tableBody = document.getElementById('export-check-table-body');
            const selectAllCheckbox = document.getElementById('select-all-checkbox');
            
            // Clear previous content
            tableBody.innerHTML = '';
            
            // Get file analysis for duplicate checking
            let fileInfo = null;
            if (previousExportData && previousExportData.length > 0) {
                fileInfo = checkDuplicateFiles();
            }
            
            // Store file data for later use
            window.exportCheckData = {
                passedFiles: passedFiles,
                failedFiles: failedFiles,
                fileInfo: fileInfo,
                selectedFiles: new Set()
            };
            
            // Add previous export row if exists
            if (previousExportData && previousExportData.length > 0) {
                const row = document.createElement('tr');
                row.style.backgroundColor = '#e8f5e8';
                row.innerHTML = `
                    <td>-</td>
                    <td><strong>‰πãÂâçÁöÑÂåØÂá∫Ê™îÊ°à</strong></td>
                    <td><span class="status-icon">‚úÖ</span>ÊúÉÂåØÂá∫</td>
                    <td><span class="status-icon">‚úÖ</span>Â∑≤È©óË≠â</td>
                    <td><span class="status-icon">-</span>N/A</td>
                    <td>Âü∫Ê∫ñÊ™îÊ°à</td>
                    <td>${previousExportData.length}</td>
                    <td>‰ΩúÁÇ∫Âêà‰ΩµÂü∫Ê∫ñÔºåÁ∏ΩÊòØÂåÖÂê´</td>
                `;
                tableBody.appendChild(row);
            }
            
            // Add passed files
            passedFiles.forEach(file => {
                const recordCount = file.data ? file.data.length : 0;
                let willExport = true;
                let hasDuplicates = false;
                let duplicateWith = '';
                let duplicateCount = 0;
                let explanation = '';
                
                // Check for duplicates if we have previous export data
                if (fileInfo) {
                    const isValid = fileInfo.validFiles.find(f => f.fileName === file.fileName);
                    const isInvalid = fileInfo.invalidFiles.find(f => f.fileName === file.fileName);
                    
                    if (isInvalid) {
                        willExport = false;
                        hasDuplicates = true;
                        duplicateWith = '‰πãÂâçÂåØÂá∫Ê™îÊ°à';
                        duplicateCount = isInvalid.duplicateCount;
                        explanation = `Ëàá‰πãÂâçÂåØÂá∫Ê™îÊ°àÊúâ ${duplicateCount} Á≠ÜÈáçË§áË®òÈåÑÔºåÊï¥ÂÄãÊ™îÊ°àË¢´ÊéíÈô§`;
                    } else if (isValid) {
                        willExport = true;
                        hasDuplicates = false;
                        explanation = 'È©óË≠âÈÄöÈÅé‰∏îÁÑ°ÈáçË§áË®òÈåÑ';
                    }
                } else {
                    explanation = 'È©óË≠âÈÄöÈÅéÔºåÁÑ°‰πãÂâçÂåØÂá∫Ê™îÊ°àÂèØÊØîËºÉ';
                }
                
                const row = document.createElement('tr');
                const checkboxId = `file-checkbox-${file.fileName.replace(/[^a-zA-Z0-9]/g, '_')}`;
                
                row.innerHTML = `
                    <td>
                        ${willExport ? `<input type="checkbox" id="${checkboxId}" ${willExport ? 'checked' : ''} onchange="updateFileSelection('${file.fileName}', this.checked)">` : '-'}
                    </td>
                    <td>${file.fileName}</td>
                    <td>
                        <span class="status-icon">${willExport ? '‚úÖ' : '‚ùå'}</span>
                        ${willExport ? 'ÊúÉÂåØÂá∫' : '‰∏çÊúÉÂåØÂá∫'}
                    </td>
                    <td><span class="status-icon">‚úÖ</span>ÈÄöÈÅé</td>
                    <td>
                        <span class="status-icon">${hasDuplicates ? '‚ö†Ô∏è' : '‚úÖ'}</span>
                        ${hasDuplicates ? 'ÊúâÈáçË§á' : 'ÁÑ°ÈáçË§á'}
                    </td>
                    <td>${duplicateWith || '-'}</td>
                    <td>${recordCount}</td>
                    <td>${explanation}</td>
                `;
                
                tableBody.appendChild(row);
                
                // Add to selected files if will export
                if (willExport) {
                    window.exportCheckData.selectedFiles.add(file.fileName);
                }
            });
            
            // Add failed files
            failedFiles.forEach(fileName => {
                const row = document.createElement('tr');
                row.style.backgroundColor = '#ffe6e6';
                row.innerHTML = `
                    <td>-</td>
                    <td>${fileName}</td>
                    <td><span class="status-icon">‚ùå</span>‰∏çÊúÉÂåØÂá∫</td>
                    <td><span class="status-icon">‚ùå</span>Êú™ÈÄöÈÅé</td>
                    <td><span class="status-icon">-</span>N/A</td>
                    <td>-</td>
                    <td>-</td>
                    <td>Êú™ÈÄöÈÅéTPMÈ©óË≠âË¶èÂâá</td>
                `;
                tableBody.appendChild(row);
            });
            
            // Set up select all checkbox
            selectAllCheckbox.onchange = function() {
                const checkboxes = tableBody.querySelectorAll('input[type="checkbox"]');
                checkboxes.forEach(cb => {
                    cb.checked = this.checked;
                    const fileName = cb.id.replace('file-checkbox-', '').replace(/_/g, ' ');
                    updateFileSelection(fileName, this.checked);
                });
            };
            
            updateExportSummary();
            modal.style.display = 'block';
        }
        
        function updateFileSelection(fileName, isSelected) {
            if (isSelected) {
                window.exportCheckData.selectedFiles.add(fileName);
            } else {
                window.exportCheckData.selectedFiles.delete(fileName);
            }
            updateExportSummary();
        }
        
        function updateExportSummary() {
            const summary = document.getElementById('export-summary');
            const selectionSummary = document.getElementById('selection-summary');
            
            const selectedCount = window.exportCheckData.selectedFiles.size;
            const availableCount = window.exportCheckData.passedFiles.filter(f => {
                if (!window.exportCheckData.fileInfo) return true;
                return window.exportCheckData.fileInfo.validFiles.find(vf => vf.fileName === f.fileName);
            }).length;
            
            let totalRecords = previousExportData ? previousExportData.length : 0;
            window.exportCheckData.selectedFiles.forEach(fileName => {
                const file = window.exportCheckData.passedFiles.find(f => f.fileName === fileName);
                if (file && file.data) {
                    totalRecords += file.data.length;
                }
            });
            
            selectionSummary.textContent = `Â∑≤ÈÅ∏Êìá ${selectedCount} / ${availableCount} ÂÄãÂèØÂåØÂá∫Ê™îÊ°à`;
            
            summary.innerHTML = `
                <h4>üìä ÂåØÂá∫ÊëòË¶Å</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                    <div>
                        <p><strong>Ê™îÊ°àÁµ±Ë®àÔºö</strong></p>
                        <ul>
                            <li>ÂèØÈÅ∏ÊìáÊ™îÊ°àÔºö${availableCount} ÂÄã</li>
                            <li>Â∑≤ÈÅ∏ÊìáÊ™îÊ°àÔºö${selectedCount} ÂÄã</li>
                            <li>ÁÑ°Ê≥ïÂåØÂá∫Ê™îÊ°àÔºö${window.exportCheckData.failedFiles.length + (window.exportCheckData.fileInfo ? window.exportCheckData.fileInfo.invalidFiles.length : 0)} ÂÄã</li>
                        </ul>
                    </div>
                    <div>
                        <p><strong>Ë®òÈåÑÁµ±Ë®àÔºö</strong></p>
                        <ul>
                            ${previousExportData ? `<li>‰πãÂâçÂåØÂá∫Ôºö${previousExportData.length} Á≠Ü</li>` : ''}
                            <li>Êú¨Ê¨°ÈÅ∏ÊìáÔºö${totalRecords - (previousExportData ? previousExportData.length : 0)} Á≠Ü</li>
                            <li><strong>Á∏ΩË®àÔºö${totalRecords} Á≠Ü</strong></li>
                        </ul>
                    </div>
                </div>
            `;
        }
        
        function closeExportCheckModal() {
            document.getElementById('export-check-modal').style.display = 'none';
        }
        
        function proceedWithSelectedExport() {
            const selectedFiles = Array.from(window.exportCheckData.selectedFiles);
            
            if (selectedFiles.length === 0 && (!previousExportData || previousExportData.length === 0)) {
                alert('Ë´ãËá≥Â∞ëÈÅ∏Êìá‰∏ÄÂÄãÊ™îÊ°àÈÄ≤Ë°åÂåØÂá∫');
                return;
            }
            
            // Filter selected files
            const filesToExport = window.exportCheckData.passedFiles.filter(f => 
                selectedFiles.includes(f.fileName)
            );
            
            closeExportCheckModal();
            performActualExport(filesToExport);
        }
        
        function performActualExport(filesToExport) {
            // This is the actual export logic separated from the UI
            try {
                // Combine all data: previous export + selected current files
                const allData = [];
                let previousContribution = 0;
                let currentContribution = 0;
                
                // First, add previous export data if available
                if (previousExportData && previousExportData.length > 0) {
                    previousExportData.forEach(entry => {
                        const normalizedEntry = { ...entry };
                        
                        if (normalizedEntry.Date) {
                            normalizedEntry.Date = normalizeDateFormat(normalizedEntry.Date);
                        }
                        if (normalizedEntry['Start Date']) {
                            normalizedEntry['Start Date'] = normalizeDateFormat(normalizedEntry['Start Date']);
                        }
                        if (normalizedEntry['End Date']) {
                            normalizedEntry['End Date'] = normalizeDateFormat(normalizedEntry['End Date']);
                        }
                        
                        allData.push(normalizedEntry);
                        previousContribution++;
                    });
                }
                
                // Then, add selected current file data
                filesToExport.forEach(file => {
                    if (file.data && Array.isArray(file.data)) {
                        file.data.forEach(entry => {
                            const normalizedEntry = { ...entry };
                            
                            if (normalizedEntry.Date) {
                                normalizedEntry.Date = normalizeDateFormat(normalizedEntry.Date);
                            }
                            if (normalizedEntry['Start Date']) {
                                normalizedEntry['Start Date'] = normalizeDateFormat(normalizedEntry['Start Date']);
                            }
                            if (normalizedEntry['End Date']) {
                                normalizedEntry['End Date'] = normalizeDateFormat(normalizedEntry['End Date']);
                            }
                            
                            allData.push(normalizedEntry);
                            currentContribution++;
                        });
                    }
                });
                
                if (allData.length === 0) {
                    alert('ÈÅ∏ÊìáÁöÑÊ™îÊ°à‰∏≠Ê≤íÊúâÊúâÊïàÁöÑË≥áÊñô');
                    return;
                }
                
                // Generate CSV headers
                const headers = [
                    'Name', 'Zone', 'Project', 'Product Module', 'Activity Type', 'Task',
                    'Regular Hours', 'OT Hours', 'TTL_Hours', 'Date', 'Start Date', 'End Date',
                    'Comments', 'PM', 'InternalOrOutsource'
                ];
                
                // Generate CSV rows
                const csvRows = [headers];
                allData.forEach(entry => {
                    csvRows.push([
                        entry.Name || '',
                        entry.Zone || '',
                        entry.Project || '',
                        entry['Product Module'] || '',
                        entry['Activity Type'] || '',
                        entry.Task || '',
                        entry['Regular Hours'] || '',
                        entry['OT Hours'] || '',
                        entry.TTL_Hours || '',
                        entry.Date || '',
                        entry['Start Date'] || '',
                        entry['End Date'] || '',
                        entry.Comments || '',
                        entry.PM || '',
                        entry.InternalOrOutsource || ''
                    ]);
                });
                
                // Generate CSV content with proper escaping
                const csvContent = csvRows.map(row =>
                    row.map(field => {
                        const fieldStr = String(field);
                        if (fieldStr.includes(',') || fieldStr.includes('\n') || fieldStr.includes('"')) {
                            return '"' + fieldStr.replace(/"/g, '""') + '"';
                        }
                        return fieldStr;
                    }).join(',')
                ).join('\n');
                
                // Create download with timestamp
                const now = new Date();
                const timestamp = now.toISOString().slice(0, 19).replace(/:/g, '-');
                const filename = `TPM_Validated_Combined_${timestamp}.csv`;
                
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                // Create success message
                let successMessage = `üéâ ÂåØÂá∫ÊàêÂäüÔºÅ\n\n`;
                successMessage += `üìÅ Ê™îÊ°àÂêçÁ®±Ôºö${filename}\n`;
                successMessage += `üìä ÊúÄÁµÇË®òÈåÑÊï∏Ôºö${allData.length} Á≠Ü\n\n`;
                successMessage += `üìã Âêà‰ΩµÁµ±Ë®àÔºö\n`;
                
                if (previousExportData && previousExportData.length > 0) {
                    successMessage += `  ‚Ä¢ ‰πãÂâçÂåØÂá∫Ê™îÊ°àÔºö${previousContribution} Á≠ÜË®òÈåÑ\n`;
                }
                successMessage += `  ‚Ä¢ Êú¨Ê¨°ÈÅ∏ÊìáÊ™îÊ°àÔºö${filesToExport.length} ÂÄãÔºå${currentContribution} Á≠ÜË®òÈåÑ\n`;
                
                alert(successMessage);
                
            } catch (error) {
                console.error('ÂåØÂá∫Â§±Êïó:', error);
                alert('ÂåØÂá∫Â§±ÊïóÔºåË´ãÊ™¢Êü•ÊéßÂà∂Âè∞ÈåØË™§Ë®äÊÅØ');
            }
        }
        
            
        let previousExportData = null;
        
        // Generate a unique key for a record to detect duplicates
        function generateRecordKey(entry) {
            // Use key fields to create a unique identifier
            return `${entry.Name || ''}_${entry.Zone || ''}_${entry.Project || ''}_${entry.Task || ''}_${entry.Date || ''}_${entry['Regular Hours'] || ''}_${entry['OT Hours'] || ''}`;
        }
        
        // Check for duplicate records between previous export and current passed files
        // If any duplicates found, the entire file containing duplicates will be excluded
        function checkDuplicateFiles() {
            if (!previousExportData || previousExportData.length === 0) {
                return { 
                    duplicateFiles: [], 
                    duplicateFileCount: 0,
                    totalPreviousRecords: 0,
                    totalCurrentRecords: 0,
                    validFiles: [],
                    invalidFiles: [],
                    totalDuplicateRecords: 0
                };
            }
            
            // Create a set of previous export record keys for fast lookup
            const previousRecordKeys = new Set();
            previousExportData.forEach(entry => {
                const key = generateRecordKey(entry);
                previousRecordKeys.add(key);
            });
            
            // Check each passed file for duplicates
            const validFiles = [];
            const invalidFiles = [];
            let totalDuplicateRecords = 0;
            
            validationFiles.forEach((fileInfo, fileName) => {
                if (fileInfo.results && fileInfo.results.overallResult === 'PASS' && fileInfo.data) {
                    let fileHasDuplicates = false;
                    let fileDuplicateCount = 0;
                    
                    // Check if any record in this file duplicates with previous export
                    fileInfo.data.forEach(entry => {
                        const key = generateRecordKey(entry);
                        if (previousRecordKeys.has(key)) {
                            fileHasDuplicates = true;
                            fileDuplicateCount++;
                        }
                    });
                    
                    if (fileHasDuplicates) {
                        invalidFiles.push({
                            fileName: fileName,
                            recordCount: fileInfo.data.length,
                            duplicateCount: fileDuplicateCount
                        });
                        totalDuplicateRecords += fileDuplicateCount;
                    } else {
                        validFiles.push({
                            fileName: fileName,
                            recordCount: fileInfo.data.length,
                            data: fileInfo.data
                        });
                    }
                }
            });
            
            const totalCurrentRecords = validFiles.reduce((sum, file) => sum + file.recordCount, 0);
            
            return {
                duplicateFiles: invalidFiles,
                duplicateFileCount: invalidFiles.length,
                totalPreviousRecords: previousExportData.length,
                totalCurrentRecords: totalCurrentRecords,
                validFiles: validFiles,
                invalidFiles: invalidFiles,
                totalDuplicateRecords: totalDuplicateRecords,
                passedFileCount: validFiles.length
            };
        }
        
        function handlePreviousFileSelection(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const text = e.target.result;
                    const parsedData = parseCSVContent(text);
                    
                    if (parsedData.length === 0) {
                        alert('ÈÅ∏ÊìáÁöÑÊ™îÊ°àÊ†ºÂºè‰∏çÊ≠£Á¢∫ÊàñÁÇ∫Á©∫');
                        return;
                    }
                    
                    previousExportData = parsedData;
                    
                    let displayText = `‚úì ${file.name} (${parsedData.length} Á≠ÜË®òÈåÑ)`;
                    
                    document.getElementById('previous-file-name').textContent = displayText;
                    document.getElementById('btn-clear-previous').style.display = 'inline-block';
                    
                    // Simple confirmation message without duplicate checking
                    const message = `ËºâÂÖ•‰πãÂâçÁöÑÂåØÂá∫Ê™îÊ°àÂÆåÊàêÔºÅ\n\n` +
                        `üìÅ Ê™îÊ°àÂêçÁ®±Ôºö${file.name}\n` +
                        `üìä Ë®òÈåÑÊï∏ÈáèÔºö${parsedData.length} Á≠Ü\n\n` +
                        `‚úÖ Ê™îÊ°àÂ∑≤ÊàêÂäüËºâÂÖ•ÔºåÂ∞áÂú®ÂåØÂá∫ÊôÇ‰ΩúÁÇ∫Âêà‰ΩµÂü∫Ê∫ñ„ÄÇ\n` +
                        `ÈáçË§áÊ™¢Êü•Â∞áÂú®Êåâ„ÄåÂåØÂá∫„ÄçÊåâÈàïÊôÇÈÄ≤Ë°å„ÄÇ`;
                    
                    alert(message);
                    
                } catch (error) {
                    alert('ËÆÄÂèñ‰πãÂâçÁöÑÂåØÂá∫Ê™îÊ°àÊôÇÁôºÁîüÈåØË™§ÔºåË´ãÁ¢∫Ë™çÊ™îÊ°àÊ†ºÂºèÊ≠£Á¢∫');
                    console.error('Ëß£Êûê‰πãÂâçÂåØÂá∫Ê™îÊ°àÈåØË™§:', error);
                }
            };
            reader.readAsText(file);
        }
        
        function clearPreviousFile() {
            previousExportData = null;
            document.getElementById('previous-file-name').textContent = '';
            document.getElementById('btn-clear-previous').style.display = 'none';
            document.getElementById('previous-export-file').value = '';
            console.log('üóëÔ∏è Â∑≤Ê∏ÖÈô§‰πãÂâçÁöÑÂåØÂá∫Ê™îÊ°à');
        }
        
        // ==================== INITIALIZATION ====================
        
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('üìã ÂàùÂßãÂåñ TPM È©óË≠âÂÑÄË°®Êùø...');
            
            // Load reference data first
            const loaded = await loadReferenceData();
            if (!loaded) {
                document.getElementById('overall-status').textContent = '‚ùå ÁÑ°Ê≥ïËºâÂÖ•ÂèÉËÄÉË≥áÊñôÔºåË´ãÊ™¢Êü• CSV Ê™îÊ°à';
                document.getElementById('overall-status').classList.remove('hidden');
                return;
            }
            
            // Set up file upload
            const fileInput = document.getElementById('csv-file-input');
            const uploadArea = document.getElementById('file-upload-area');
            
            // File input change
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileSelection(Array.from(e.target.files));
                }
            });
            
            // Drag and drop
            uploadArea.addEventListener('click', () => fileInput.click());
            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#007bff';
            });
            
            uploadArea.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#ccc';
            });
            
            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.style.borderColor = '#ccc';
                
                const files = Array.from(e.dataTransfer.files).filter(f => f.name.toLowerCase().endsWith('.csv'));
                if (files.length > 0) {
                    handleFileSelection(files);
                }
            });
            
            // Button events
            document.getElementById('btn-select-files').addEventListener('click', () => fileInput.click());
            document.getElementById('btn-validate-all').addEventListener('click', validateAllFiles);
            document.getElementById('btn-clear-all').addEventListener('click', clearAllFiles);
            document.getElementById('btn-export-all-passed').addEventListener('click', exportAllPassedFiles);
            document.getElementById('btn-export-corrected').addEventListener('click', exportCorrectedFile);
            document.getElementById('btn-revalidate-file').addEventListener('click', revalidateCurrentFile);
            document.getElementById('btn-remove-file').addEventListener('click', removeCurrentFile);
            
            // Previous export merge events
            const previousExportInput = document.getElementById('previous-export-file');
            document.getElementById('btn-select-previous').addEventListener('click', () => {
                previousExportInput.value = ''; // Clear value to ensure change event fires
                previousExportInput.click();
            });
            document.getElementById('btn-clear-previous').addEventListener('click', clearPreviousFile);
            previousExportInput.addEventListener('change', handlePreviousFileSelection);
            
            console.log('‚úÖ TPM È©óË≠âÂÑÄË°®ÊùøÂàùÂßãÂåñÂÆåÊàê');
        });
    </script>

    <!-- Export Check Modal -->
    <div id="export-check-modal" class="export-check-modal">
        <div class="export-check-content">
            <div class="export-check-header">
                <h2>üìã TPM ÂåØÂá∫Ê™¢Êü•Ê∏ÖÂñÆ</h2>
                <p>Ë´ãÊ™¢Êü•‰ª•‰∏ãÊ™îÊ°àÁãÄÊÖãÔºå‰∏¶ÈÅ∏ÊìáË¶ÅÂåØÂá∫ÁöÑÊ™îÊ°à</p>
            </div>
            
            <div class="select-all-section">
                <label>
                    <input type="checkbox" id="select-all-checkbox"> 
                    <strong>ÂÖ®ÈÅ∏/ÂèñÊ∂àÂÖ®ÈÅ∏ÂèØÂåØÂá∫ÁöÑÊ™îÊ°à</strong>
                </label>
                <span id="selection-summary" style="margin-left: 20px; color: #666;"></span>
            </div>
            
            <div style="overflow-x: auto;">
                <table class="export-check-table">
                    <thead>
                        <tr>
                            <th style="width: 50px;">ÈÅ∏Êìá</th>
                            <th style="width: 200px;">Ê™îÊ°àÂêçÁ®±</th>
                            <th style="width: 80px;">ÊúÉÂåØÂá∫</th>
                            <th style="width: 100px;">È©óË≠âÈÄöÈÅé</th>
                            <th style="width: 80px;">ÊúâÈáçË§á</th>
                            <th style="width: 150px;">ÈáçË§áÊ™îÊ°à</th>
                            <th style="width: 80px;">Ë®òÈåÑÊï∏</th>
                            <th>Ë™™Êòé</th>
                        </tr>
                    </thead>
                    <tbody id="export-check-table-body">
                        <!-- Table rows will be dynamically generated -->
                    </tbody>
                </table>
            </div>
            
            <div id="export-summary" style="margin: 20px 0; padding: 15px; background-color: #f8f9fa; border-radius: 5px;">
                <!-- Summary will be dynamically generated -->
            </div>
            
            <div class="export-actions">
                <button class="btn btn-secondary" onclick="closeExportCheckModal()">ÂèñÊ∂à</button>
                <button class="btn btn-primary" onclick="proceedWithSelectedExport()">Á¢∫Ë™çÂåØÂá∫ÈÅ∏‰∏≠ÁöÑÊ™îÊ°à</button>
            </div>
        </div>
    </div>
</body>
</html>